{% extends 'base_user.html' %}
{% block title %}Tableau de bord - Enseignant{% endblock %}

{% block content %}
<section class="teacher-interface" style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start;">
    <div style="flex:1 1 100%;">
        <h2 style="margin-top:0;">Créer un nouveau quiz</h2>
        <form method="post" class="form">
            <div class="mb-3">
                <label class="form-label">Titre du quiz</label>
                <input type="text" name="title" class="form-control" placeholder="Titre du quiz" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Description (optionnelle)</label>
                <textarea name="description" class="form-control" rows="2" placeholder="Description..."></textarea>
            </div>

            <div id="questions-container">
                <!-- Question initiale (index 0) -->
                <div class="question-block mb-4 p-3 border rounded" data-index="0">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Question <span class="question-number">1</span></h5>
                        <button type="button" class="btn btn-sm btn-danger remove-question">Supprimer</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Intitulé de la question</label>
                        <input type="text" name="questions[0][text]" class="form-control" placeholder="Texte de la question" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Choix</label>
                        <div class="choices">
                            <div class="input-group mb-2 choice-item" data-choice-index="0">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[0][correct]" value="0" aria-label="Choix correct">
                                </div>
                                <input type="text" name="questions[0][choices][0]" class="form-control" placeholder="Choix 1" required>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-choice" title="Supprimer le choix">×</button>
                            </div>

                            <div class="input-group mb-2 choice-item" data-choice-index="1">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[0][correct]" value="1" aria-label="Choix correct">
                                </div>
                                <input type="text" name="questions[0][choices][1]" class="form-control" placeholder="Choix 2" required>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-choice" title="Supprimer le choix">×</button>
                            </div>

                            <div class="input-group mb-2 choice-item" data-choice-index="2">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[0][correct]" value="2" aria-label="Choix correct">
                                </div>
                                <input type="text" name="questions[0][choices][2]" class="form-control" placeholder="Choix 3" required>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-choice" title="Supprimer le choix">×</button>
                            </div>

                            <div class="input-group mb-2 choice-item" data-choice-index="3">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[0][correct]" value="3" aria-label="Choix correct">
                                </div>
                                <input type="text" name="questions[0][choices][3]" class="form-control" placeholder="Choix 4" required>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-choice" title="Supprimer le choix">×</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-choice">+ Ajouter un choix</button>
                    </div>
                </div>
            </div>

            <!-- Template pour JavaScript : remplacer __index__ par le numéro de la question -->
            <template id="question-template">
                <div class="question-block mb-4 p-3 border rounded" data-index="__index__">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Question <span class="question-number">__num__</span></h5>
                        <button type="button" class="btn btn-sm btn-danger remove-question">Supprimer</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Intitulé de la question</label>
                        <input type="text" name="questions[__index__][text]" class="form-control" placeholder="Texte de la question" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Choix</label>
                        <div class="choices">
                            <div class="input-group mb-2 choice-item" data-choice-index="0">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[__index__][correct]" value="0" aria-label="Choix correct">
                                </div>
                                <input type="text" name="questions[__index__][choices][0]" class="form-control" placeholder="Choix 1" required>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-choice">×</button>
                            </div>
                            <div class="input-group mb-2 choice-item" data-choice-index="1">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[__index__][correct]" value="1" aria-label="Choix correct">
                                </div>
                                <input type="text" name="questions[__index__][choices][1]" class="form-control" placeholder="Choix 2" required>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-choice">×</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-choice">+ Ajouter un choix</button>
                    </div>
                </div>
            </template>

            <button type="button" class="btn btn-secondary mb-3" onclick="addQuestion()">+ Ajouter une question</button>
            <button type="submit" class="btn btn-primary">Créer le quiz</button>
        </form>
    </div>
</section>

<script>
function addQuestion() {
    const container = document.getElementById('questions-container');
    const questionBlocks = container.querySelectorAll('.question-block');
    const newIndex = questionBlocks.length;
    const template = document.getElementById('question-template');
    
    const newQuestion = template.content.cloneNode(true);
    const questionHtml = new XMLSerializer().serializeToString(newQuestion);
    const updatedHtml = questionHtml
        .replace(/__index__/g, newIndex)
        .replace(/__num__/g, newIndex + 1);
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = updatedHtml;
    container.appendChild(tempDiv.firstElementChild);
    
    attachEventListeners();
}

function attachEventListeners() {
    document.querySelectorAll('.remove-question').forEach(btn => {
        btn.onclick = function() {
            this.closest('.question-block').remove();
            updateQuestionNumbers();
        };
    });
    
    document.querySelectorAll('.add-choice').forEach(btn => {
        btn.onclick = function() {
            addChoice(this);
        };
    });
    
    document.querySelectorAll('.remove-choice').forEach(btn => {
        btn.onclick = function() {
            this.closest('.choice-item').remove();
        };
    });
}

function addChoice(button) {
    const choices = button.previousElementSibling;
    const choiceIndex = choices.querySelectorAll('.choice-item').length;
    const questionBlock = button.closest('.question-block');
    const questionIndex = questionBlock.dataset.index;
    
    const newChoice = document.createElement('div');
    newChoice.className = 'input-group mb-2 choice-item';
    newChoice.dataset.choiceIndex = choiceIndex;
    newChoice.innerHTML = `
        <div class="input-group-text">
            <input type="radio" name="questions[${questionIndex}][correct]" value="${choiceIndex}" aria-label="Choix correct">
        </div>
        <input type="text" name="questions[${questionIndex}][choices][${choiceIndex}]" class="form-control" placeholder="Choix ${choiceIndex + 1}" required>
        <button type="button" class="btn btn-outline-danger btn-sm remove-choice">×</button>
    `;
    
    choices.appendChild(newChoice);
    newChoice.querySelector('.remove-choice').onclick = function() {
        this.closest('.choice-item').remove();
    };
}

function updateQuestionNumbers() {
    document.querySelectorAll('.question-block').forEach((block, index) => {
        block.dataset.index = index;
        block.querySelector('.question-number').textContent = index + 1;
    });
}

attachEventListeners();
</script>
{% endblock %}
