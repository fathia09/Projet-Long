{% extends "base.html" %}

{% block title %}√âditer le quiz{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/enseignant/styleEditQuiz.css') }}">
<div class="quiz-edit-container">
    <h2>√âditer: {{ quiz.titre }}</h2>
    <section class="existing-questions">
        <h3>Questions existantes</h3>
        {% for item in questions %}
        <div class="question">
            <div class="question-header">
                <strong>{{ item.question.enonce }}</strong>
                <span>({{ item.question.type }}, {{ item.question.bareme }} pts, {{ item.question.duree }}s)</span>
            </div>


            <!-- Actions -->
            <div class="action-links">
                <a href="{{ url_for('enseignant.edit_question', question_id=item.question.id) }}">Modifier</a>
                <a href="{{ url_for('enseignant.delete_question', question_id=item.question.id) }}">Supprimer</a>
            </div>
            
            {% if item.choix %}
            <ul class="choices-list">
                {% for c in item.choix %}
                <li>{{ c.texte }} {% if c.est_correct %} ‚úì{% endif %}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endfor %}
    </section>

    <section class="add-question">
        <h3>Ajouter une question</h3>
        
        <form method="post">
            <input type="hidden" name="action" value="add_question">
            
            <textarea name="enonce" placeholder="√ânonc√© de la question" required rows="3"></textarea>
            
            <select name="type" id="type" onchange="updateChoixFields()" required>
                <option value="">Type de question</option>
                <option value="QCM_simple">QCM simple</option>
                <option value="QCM_multiple">QCM multiple</option>
                <option value="Vrai_Faux">Vrai/Faux</option>
                <option value="numerique">Num√©rique</option>
            </select>
            
            <div class="form-row">
                <input type="number" name="bareme" step="0.5" value="1" placeholder="Bar√®me" required min="0.5">
                <input type="number" name="duree_question" value="60" placeholder="Dur√©e (secondes)" required min="10">
            </div>

            <div id="zoneQCM" style="display: none;">
                <p><strong>R√©ponses possibles (Cochez les bonnes r√©ponses) :</strong></p>
    
                <div id="choix-container">
        
                <div class="choix-item" style="margin-bottom: 10px;">
                    <input type="checkbox" name="correct[]" value="0">
                    <input type="text" name="choix[]" placeholder="R√©ponse 1" required style="width: 70%;">
                </div>

                <div class="choix-item" style="margin-bottom: 10px;">
                    <input type="checkbox" name="correct[]" value="1">
                    <input type="text" name="choix[]" placeholder="R√©ponse 2" required style="width: 70%;">
                </div>

                </div>

                <button type="button" onclick="ajouterChoix()" style="margin-top: 10px; background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                     + Ajouter une autre r√©ponse
                </button>
            </div>

            <div id="zoneVraiFaux" style="display: none; margin-top: 15px; padding: 15px; border: 1px solid #ddd; background-color: #f8f9fa; border-radius: 5px; text-align: center;">
                <p><strong>Quelle est la bonne r√©ponse ?</strong></p>
                <div style="display: flex; justify-content: center; gap: 30px;">
                    <label style="cursor: pointer; font-weight: bold; color: green; font-size: 1.1em;">
                        <input type="radio" name="correct_vf" value="vrai"> VRAI
                    </label>
                    
                    <label style="cursor: pointer; font-weight: bold; color: red; font-size: 1.1em;">
                        <input type="radio" name="correct_vf" value="faux"> FAUX
                    </label>
                </div>
            </div>
            
            <button type="submit">Ajouter la question</button>
        </form>
    </section>

    <section class="quiz-actions">
        <form method="post" style="display: inline;">
            <input type="hidden" name="action" value="publish">
            <button type="submit" class="btn-publish">Publier le quiz</button>
        </form>
        
        <a href="{{ url_for('enseignant.dashboard') }}">
            <button class="btn-back">Retour au tableau de bord</button>
        </a>
    </section>
</div>

<script>
function updateChoixFields() {
    const type = document.getElementById('type').value;    
    const zoneQCM = document.getElementById('zoneQCM');
    const zoneVraiFaux = document.getElementById('zoneVraiFaux');    
    const inputsQCM = zoneQCM.querySelectorAll('input[type="text"]');
    const inputsVF = zoneVraiFaux.querySelectorAll('input[type="radio"]');
    
    if (type === 'Vrai_Faux') {
        zoneQCM.style.display = 'none';      
        zoneVraiFaux.style.display = 'block';
        inputsQCM.forEach(function(input) {
            input.required = false;
        });
        inputsVF.forEach(function(input) {
            input.required = true;
        });

    } 
    else if (type === 'QCM_simple' || type === 'QCM_multiple') {
        zoneQCM.style.display = 'block';     
        zoneVraiFaux.style.display = 'none';
        inputsQCM.forEach(function(input) {
            input.required = true;
        });
        inputsVF.forEach(function(input) {
            input.required = false;
        });
    } 
    else {
        zoneQCM.style.display = 'none';
        zoneVraiFaux.style.display = 'none';
        inputsQCM.forEach(input => input.required = false);
        inputsVF.forEach(input => input.required = false);
    }
}
function ajouterChoix() {
    const container = document.getElementById('choix-container');
    const index = container.children.length;
    const div = document.createElement('div');
    const estModeQCM = document.getElementById('zoneQCM').style.display !== 'none';
    div.className = 'choix-item';
    div.style.marginBottom = '10px';
    div.innerHTML = `
        <input type="checkbox" name="correct[]" value="${index}">
        <input type="text" name="choix[]" placeholder="R√©ponse ${index + 1}" ${estModeQCM ? 'required' : ''} style="width: 70%;">
        <button type="button" onclick="supprimerChoix(this)" style="margin-left: 5px; color: red; border: none; background: none; cursor: pointer;">üóëÔ∏è</button>
    `;
    container.appendChild(div);
}
function supprimerChoix(button) {
    const container = document.getElementById('choix-container');
    if (container.children.length <= 2) {
        alert("Un QCM doit avoir au minimum 2 choix !");
        return;
    }
    button.parentElement.remove();   
    reindexerChoix();
}
function reindexerChoix() {
    const container = document.getElementById('choix-container');
    const items = container.getElementsByClassName('choix-item');   
    for (let i = 0; i < items.length; i++) {
        const checkbox = items[i].querySelector('input[type="checkbox"]');
        const textInput = items[i].querySelector('input[type="text"]');        
        checkbox.value = i;
        textInput.placeholder = `R√©ponse ${i + 1}`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateChoixFields();
});
</script>
{% endblock %}